#!/usr/bin/env python3
import os
import sys
import subprocess
import http.server
import socketserver
import getpass
from dotenv import load_dotenv

# On charge le .env situé dans le même dossier que nexus
load_dotenv()

# --- CONFIGURATION RÉCUPÉRÉE DEPUIS LE .ENV ---
VPS_USER = os.getenv("VPS_USER", "debian")
VPS_IP = os.getenv("VPS_IP")
VPS_PORT = os.getenv("VPS_PORT", "22")
LOCAL_DIR = os.getenv("LOCAL_DIR", "./")
REMOTE_DIR = os.getenv("REMOTE_DIR", "./")
WEB_DIR = os.getenv("WEB_DIR", "./")

# --- DÉTECTION D'ENVIRONNEMENT ---
CURRENT_USER = getpass.getuser()
IS_VPS = (CURRENT_USER == VPS_USER)

def print_banner():
    print("\033[92m")
    print("==================================================")
    print("  0xee_NEXUS // OMNI-ENVIRONMENT TERMINAL         ")
    print("==================================================")
    print("\033[0m")

def serve():
    PORT = 8000
    try:
        os.chdir(WEB_DIR)
        loc = "VPS" if IS_VPS else "LOCAL"
        print(f"[\033[96m{loc}\033[0m] Serveur web sur http://localhost:{PORT} (Ctrl+C pour stopper)")
        with socketserver.TCPServer(("", PORT), http.server.SimpleHTTPRequestHandler) as httpd:
            httpd.serve_forever()
    except FileNotFoundError:
        print(f"[\033[91mERREUR\033[0m] Dossier '{WEB_DIR}' introuvable depuis {os.getcwd()}.")
    except KeyboardInterrupt:
        print("\n[\033[96mSYSTÈME\033[0m] Extinction du serveur.")

def deploy():
    if IS_VPS:
        print("[\033[91mERREUR\033[0m] Opération interdite. Tu es déjà sur le VPS. Le déploiement se fait depuis la machine locale.")
        return

    base_cmd = [
        "rsync", "-avz", "--delete",
        "--exclude", ".git",
        "--exclude", "__pycache__",
        "--exclude", "venv/",
        "--exclude", "logs/",
        "-e", f"ssh -p {VPS_PORT}",
        LOCAL_DIR,
        f"{VPS_USER}@{VPS_IP}:{REMOTE_DIR}"
    ]

    print(f"[\033[95mBRIDGE\033[0m] Dry-run — scanning changes against {VPS_IP}...\n")
    dry = subprocess.run(base_cmd + ["--dry-run", "--itemize-changes"],
                         capture_output=True, text=True)
    lines = [l for l in dry.stdout.splitlines() if l.strip()]
    if not lines:
        print("[\033[92mNO CHANGES\033[0m] Remote is already up to date.")
        return

    for line in lines:
        # rsync itemize format: first char indicates the change type
        flag = line[0] if line else " "
        color = "\033[91m" if flag == "d" else "\033[93m" if flag == "*" else "\033[96m"
        print(f"  {color}{line}\033[0m")

    print(f"\n  {len(lines)} file(s) to sync.")
    confirm = input(f"\n[\033[93mWARNING\033[0m] Deploy to {VPS_IP} with --delete? (y/N) : ").strip().lower()
    if confirm != "y":
        print("[\033[96mCANCELLED\033[0m] Deploy aborted.")
        return

    print(f"\n[\033[95mBRIDGE\033[0m] Uplink to {VPS_IP}...")
    try:
        subprocess.run(base_cmd, check=True)
        print(f"\n[\033[92mSUCCESS\033[0m] Code synced to remote.")
    except subprocess.CalledProcessError:
        print(f"\n[\033[91mFAIL\033[0m] Sync failed.")

def backup():
    """Rapatrie la mémoire (logs et state.json) du VPS vers la machine locale."""
    if IS_VPS:
        print("[\033[91mERREUR\033[0m] Opération interdite. Tu es déjà sur le VPS.")
        return

    print(f"[\033[95mBRIDGE\033[0m] Rapatriement de la mémoire depuis {VPS_IP}...")
    
    local_logs = os.path.join(LOCAL_DIR, "logs")
    os.makedirs(local_logs, exist_ok=True)
    
    # On ajoute un slash à la fin pour rsync (copie le contenu du dossier)
    remote_logs = f"{VPS_USER}@{VPS_IP}:{os.path.join(REMOTE_DIR, 'logs')}/"
    
    cmd = [
        "rsync", "-avz",
        "-e", f"ssh -p {VPS_PORT}",
        remote_logs,
        local_logs
    ]
    try:
        subprocess.run(cmd, check=True)
        print(f"\n[\033[92mSUCCÈS\033[0m] Mémoire de l'IA (state.json et journaux) sauvegardée en local.")
    except subprocess.CalledProcessError:
        print(f"\n[\033[91mÉCHEC\033[0m] Le rapatriement a échoué.")

def check():
    """Validate all required .env variables. Fail fast with clear output."""
    required = {
        "VPS_IP":              VPS_IP,
        "VPS_USER":            VPS_USER,
        "ANTHROPIC_API_KEY":   os.getenv("ANTHROPIC_API_KEY"),
        "X_API_KEY":           os.getenv("X_API_KEY"),
        "X_API_SECRET":        os.getenv("X_API_SECRET"),
        "X_ACCESS_TOKEN":      os.getenv("X_ACCESS_TOKEN"),
        "X_ACCESS_SECRET":     os.getenv("X_ACCESS_SECRET"),
        "X_BEARER_TOKEN":      os.getenv("X_BEARER_TOKEN"),
        "SOLANA_WALLET":       os.getenv("SOLANA_WALLET"),
    }
    print_banner()
    print("[\033[96mCHECK\033[0m] Validating environment variables...\n")
    all_ok = True
    for key, value in required.items():
        if not value:
            print(f"  [\033[91mMISSING\033[0m] {key}")
            all_ok = False
        else:
            masked = "*" * 8 + value[-4:]
            print(f"  [\033[92mOK\033[0m]      {key} = {masked}")
    print()
    if all_ok:
        print("[\033[92mSUCCESS\033[0m] All variables are set. Ready to operate.")
    else:
        print("[\033[91mFAIL\033[0m] Missing variables. Check your .env file.")
        sys.exit(1)


def restart():
    """Restart the 0xeeTerm systemd timer (local on VPS, or via SSH from local)."""
    if IS_VPS:
        print("[\033[93mVPS\033[0m] Restarting 0xeeTerm.timer locally...\n")
        subprocess.run(["systemctl", "restart", "0xeeTerm.timer"])
        subprocess.run(["systemctl", "status", "0xeeTerm.timer", "--no-pager"])
    else:
        print(f"[\033[95mBRIDGE\033[0m] Restarting 0xeeTerm.timer on {VPS_IP}...\n")
        subprocess.run([
            "ssh", "-p", VPS_PORT, f"{VPS_USER}@{VPS_IP}",
            "systemctl restart 0xeeTerm.timer && systemctl status 0xeeTerm.timer --no-pager"
        ])


def trigger(action: str):
    """Run 0xeeTerm heartbeat or mentions directly on the VPS (skips the timer)."""
    valid_actions = ["heartbeat", "mentions"]
    if action not in valid_actions:
        print(f"[\033[91mERROR\033[0m] Unknown action '{action}'. Choose: {', '.join(valid_actions)}")
        sys.exit(1)

    remote_cmd = f"cd {REMOTE_DIR.rstrip('/')} && venv/bin/python3 0xeeTerm {action}"

    if IS_VPS:
        print(f"[\033[93mVPS\033[0m] Triggering 0xeeTerm {action} locally...\n")
        subprocess.run(remote_cmd, shell=True)
    else:
        print(f"[\033[95mBRIDGE\033[0m] Triggering 0xeeTerm {action} on {VPS_IP}...\n")
        subprocess.run(["ssh", "-p", VPS_PORT, f"{VPS_USER}@{VPS_IP}", remote_cmd])


def sys_status():
    if IS_VPS:
        print("[\033[93mVPS\033[0m] Lecture directe des senseurs systemd...\n")
        print("\033[96m[--- ÉTAT DU TIMER ---]\033[0m")
        result = subprocess.run(["systemctl", "list-timers"], capture_output=True, text=True)
        lines = [l for l in result.stdout.splitlines() if "0xeeTerm" in l]
        print("\n".join(lines) if lines else "Aucun timer actif.")
        print()
        print("\033[96m[--- ÉTAT DU SERVICE ---]\033[0m")
        subprocess.run(["systemctl", "status", "0xeeTerm.service", "--no-pager"])
    else:
        print(f"[\033[95mBRIDGE\033[0m] Interrogation SSH sur {VPS_IP}...\n")
        remote_cmd = (
            "echo '[--- ÉTAT DU TIMER ---]';"
            "systemctl list-timers | grep 0xeeTerm || echo 'Aucun timer actif.';"
            "echo '';"
            "echo '[--- ÉTAT DU SERVICE ---]';"
            "systemctl status 0xeeTerm.service --no-pager || true"
        )
        subprocess.run(["ssh", "-p", VPS_PORT, f"{VPS_USER}@{VPS_IP}", remote_cmd])

def sys_logs():
    if IS_VPS:
        print("[\033[93mVPS\033[0m] Extraction locale des journaux...\n")
        subprocess.run(["journalctl", "-u", "0xeeTerm.service", "-n", "15", "--no-pager"])
    else:
        print(f"[\033[95mBRIDGE\033[0m] Extraction SSH des journaux depuis {VPS_IP}...\n")
        subprocess.run(["ssh", "-p", VPS_PORT, f"{VPS_USER}@{VPS_IP}",
                        "journalctl -u 0xeeTerm.service -n 15 --no-pager"])

def show_help():
    print_banner()
    print("Usage: nexus [command]\n")

    print("\033[96m[ GLOBAL ]\033[0m")
    print("  check              : Validate all required .env variables")
    print()

    if IS_VPS:
        print("\033[93m[ VPS COMMANDS ]\033[0m")
        print("  status             : Show 0xeeTerm timer and service state")
        print("  logs               : Show last 15 lines of 0xeeTerm activity")
        print("  restart            : Restart the 0xeeTerm.timer systemd unit")
        print("  trigger heartbeat  : Run a heartbeat cycle immediately")
        print("  trigger mentions   : Run a mentions cycle immediately")
        print()
    else:
        print("\033[96m[ LOCAL & BRIDGE ]\033[0m")
        print("  serve              : Start local web server on WEB_DIR:8000")
        print("  deploy             : Push code to VPS via rsync (prompts confirmation)")
        print("  backup             : Pull logs/state.json from VPS to local")
        print()
        print("\033[93m[ REMOTE (SSH) ]\033[0m")
        print("  status             : Query timer and service state on VPS")
        print("  logs               : Fetch last 15 lines of systemd logs from VPS")
        print("  restart            : Restart 0xeeTerm.timer on VPS via SSH")
        print("  trigger heartbeat  : Trigger a heartbeat run on VPS via SSH")
        print("  trigger mentions   : Trigger a mentions run on VPS via SSH")
        print()

    mode = "VPS" if IS_VPS else "LOCAL"
    print(f"Current mode: \033[93m{mode}\033[0m")

if __name__ == "__main__":
    # Rendre le script exécutable s'il ne l'est pas
    if not os.access(__file__, os.X_OK):
        os.chmod(__file__, 0o755)

    if len(sys.argv) < 2:
        show_help()
        sys.exit(0)
    
    cmd = sys.argv[1]
    if cmd == "serve":
        serve()
    elif cmd == "deploy":
        deploy()
    elif cmd == "backup":
        backup()
    elif cmd == "status":
        sys_status()
    elif cmd == "logs":
        sys_logs()
    elif cmd == "restart":
        restart()
    elif cmd == "check":
        check()
    elif cmd == "trigger":
        if len(sys.argv) < 3:
            print(f"[\033[91mERROR\033[0m] Usage: nexus trigger [heartbeat|mentions]")
            sys.exit(1)
        trigger(sys.argv[2])
    elif cmd in ["help", "-h", "--help"]:
        show_help()
    else:
        print(f"[\033[91mERROR\033[0m] Unknown command '{cmd}'.")
        show_help()
