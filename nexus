#!/usr/bin/env python3
import os
import sys
import json
import subprocess
import http.server
import socketserver
import getpass
from pathlib import Path
from datetime import datetime, timezone
from dotenv import load_dotenv

# On charge le .env situé dans le même dossier que nexus
load_dotenv()

# --- CONFIGURATION RÉCUPÉRÉE DEPUIS LE .ENV ---
VPS_USER = os.getenv("VPS_USER", "debian")
VPS_IP = os.getenv("VPS_IP")
VPS_PORT = os.getenv("VPS_PORT", "22")
LOCAL_DIR = os.getenv("LOCAL_DIR", "./")
REMOTE_DIR = os.getenv("REMOTE_DIR", "./")
WEB_DIR = os.getenv("WEB_DIR", "./")

# --- DÉTECTION D'ENVIRONNEMENT ---
CURRENT_USER = getpass.getuser()
IS_VPS = (CURRENT_USER == VPS_USER)

# --- CHEMINS SYSTÈMES ---
INFRA_DIR    = Path(__file__).parent / "infra"
SYSTEMD_DIR  = Path("/etc/systemd/system")
MANIFEST_DIR = Path(__file__).parent / "logs"
MANIFEST_FILE = MANIFEST_DIR / "installed_files.json"

def print_banner():
    print("\033[92m")
    print("==================================================")
    print("  0xee_NEXUS // OMNI-ENVIRONMENT TERMINAL         ")
    print("==================================================")
    print("\033[0m")

def serve():
    PORT = 8000
    try:
        os.chdir(WEB_DIR)
        loc = "VPS" if IS_VPS else "LOCAL"
        print(f"[\033[96m{loc}\033[0m] Serveur web sur http://localhost:{PORT} (Ctrl+C pour stopper)")
        with socketserver.TCPServer(("", PORT), http.server.SimpleHTTPRequestHandler) as httpd:
            httpd.serve_forever()
    except FileNotFoundError:
        print(f"[\033[91mERREUR\033[0m] Dossier '{WEB_DIR}' introuvable depuis {os.getcwd()}.")
    except KeyboardInterrupt:
        print("\n[\033[96mSYSTÈME\033[0m] Extinction du serveur.")

def deploy():
    if IS_VPS:
        print("[\033[91mERREUR\033[0m] Opération interdite. Tu es déjà sur le VPS. Le déploiement se fait depuis la machine locale.")
        return

    excludes = [
        "--exclude", ".git",
        "--exclude", "__pycache__",
        "--exclude", "venv/",
        "--exclude", "logs/",
    ]
    ssh_opt = ["-e", f"ssh -p {VPS_PORT}"]
    src_dst = [LOCAL_DIR, f"{VPS_USER}@{VPS_IP}:{REMOTE_DIR}"]

    # Dry-run: no -v to avoid rsync summary noise, itemize gives us raw change codes
    print(f"[\033[95mBRIDGE\033[0m] Dry-run — scanning changes against {VPS_IP}...\n")
    dry = subprocess.run(
        ["rsync", "-az", "--delete", "--itemize-changes", "--dry-run"]
        + excludes + ssh_opt + src_dst,
        capture_output=True, text=True
    )

    # Keep only meaningful change lines — skip dir-only timestamp updates (.d..t......)
    SKIP_PREFIXES = (".d", "sending ", "sent ", "total size", "cannot ")
    lines = [
        l for l in dry.stdout.splitlines()
        if l.strip() and not any(l.startswith(p) for p in SKIP_PREFIXES)
    ]

    if not lines:
        print("[\033[92mNO CHANGES\033[0m] Remote is already up to date.")
        return

    for line in lines:
        if line.startswith("*deleting"):
            color = "\033[91m"   # red   — deletion
            label = f"  DEL  {line.split()[-1]}"
        elif line[1] == "f":
            color = "\033[93m"   # yellow — file modified or new
            label = f"  MOD  {line.split()[-1]}"
        else:
            color = "\033[96m"   # cyan  — other (symlink, etc.)
            label = f"  SYN  {line.split()[-1]}"
        print(f"{color}{label}\033[0m")

    print(f"\n  {len(lines)} file(s) to sync.")
    confirm = input(f"\n[\033[93mWARNING\033[0m] Deploy to {VPS_IP} with --delete? (y/N) : ").strip().lower()
    if confirm != "y":
        print("[\033[96mCANCELLED\033[0m] Deploy aborted.")
        return

    print(f"\n[\033[95mBRIDGE\033[0m] Uplink to {VPS_IP}...")
    try:
        subprocess.run(
            ["rsync", "-avz", "--delete"] + excludes + ssh_opt + src_dst,
            check=True
        )
        print(f"\n[\033[92mSUCCESS\033[0m] Code synced to remote.")
    except subprocess.CalledProcessError:
        print(f"\n[\033[91mFAIL\033[0m] Sync failed.")

def backup():
    """Rapatrie la mémoire (logs et state.json) du VPS vers la machine locale."""
    if IS_VPS:
        print("[\033[91mERREUR\033[0m] Opération interdite. Tu es déjà sur le VPS.")
        return

    print(f"[\033[95mBRIDGE\033[0m] Rapatriement de la mémoire depuis {VPS_IP}...")
    
    local_logs = os.path.join(LOCAL_DIR, "logs")
    os.makedirs(local_logs, exist_ok=True)
    
    # On ajoute un slash à la fin pour rsync (copie le contenu du dossier)
    remote_logs = f"{VPS_USER}@{VPS_IP}:{os.path.join(REMOTE_DIR, 'logs')}/"
    
    cmd = [
        "rsync", "-avz",
        "-e", f"ssh -p {VPS_PORT}",
        remote_logs,
        local_logs
    ]
    try:
        subprocess.run(cmd, check=True)
        print(f"\n[\033[92mSUCCÈS\033[0m] Mémoire de l'IA (state.json et journaux) sauvegardée en local.")
    except subprocess.CalledProcessError:
        print(f"\n[\033[91mÉCHEC\033[0m] Le rapatriement a échoué.")

def check():
    """Validate all required .env variables. Fail fast with clear output."""
    required = {
        "VPS_IP":              VPS_IP,
        "VPS_USER":            VPS_USER,
        "ANTHROPIC_API_KEY":   os.getenv("ANTHROPIC_API_KEY"),
        "X_API_KEY":           os.getenv("X_API_KEY"),
        "X_API_SECRET":        os.getenv("X_API_SECRET"),
        "X_ACCESS_TOKEN":      os.getenv("X_ACCESS_TOKEN"),
        "X_ACCESS_SECRET":     os.getenv("X_ACCESS_SECRET"),
        "SOLANA_WALLET":       os.getenv("SOLANA_WALLET"),
    }
    print_banner()
    print("[\033[96mCHECK\033[0m] Validating environment variables...\n")
    all_ok = True
    for key, value in required.items():
        if not value:
            print(f"  [\033[91mMISSING\033[0m] {key}")
            all_ok = False
        else:
            masked = "*" * 8 + value[-4:]
            print(f"  [\033[92mOK\033[0m]      {key} = {masked}")
    print()
    if all_ok:
        print("[\033[92mSUCCESS\033[0m] All variables are set. Ready to operate.")
    else:
        print("[\033[91mFAIL\033[0m] Missing variables. Check your .env file.")
        sys.exit(1)


def restart():
    """Restart the 0xeeTerm systemd timer (local on VPS, or via SSH from local)."""
    if IS_VPS:
        print("[\033[93mVPS\033[0m] Restarting 0xeeTerm.timer locally...\n")
        subprocess.run(["systemctl", "restart", "0xeeTerm.timer"])
        subprocess.run(["systemctl", "status", "0xeeTerm.timer", "--no-pager"])
    else:
        print(f"[\033[95mBRIDGE\033[0m] Restarting 0xeeTerm.timer on {VPS_IP}...\n")
        subprocess.run([
            "ssh", "-p", VPS_PORT, f"{VPS_USER}@{VPS_IP}",
            "systemctl restart 0xeeTerm.timer && systemctl status 0xeeTerm.timer --no-pager"
        ])


def trigger(action: str):
    """Run 0xeeTerm heartbeat or mentions directly on the VPS (skips the timer)."""
    valid_actions = ["heartbeat", "mentions"]
    if action not in valid_actions:
        print(f"[\033[91mERROR\033[0m] Unknown action '{action}'. Choose: {', '.join(valid_actions)}")
        sys.exit(1)

    remote_cmd = f"cd {REMOTE_DIR.rstrip('/')} && venv/bin/python3 0xeeTerm {action}"

    if IS_VPS:
        print(f"[\033[93mVPS\033[0m] Triggering 0xeeTerm {action} locally...\n")
        subprocess.run(remote_cmd, shell=True)
    else:
        print(f"[\033[95mBRIDGE\033[0m] Triggering 0xeeTerm {action} on {VPS_IP}...\n")
        subprocess.run(["ssh", "-p", VPS_PORT, f"{VPS_USER}@{VPS_IP}", remote_cmd])


def ssh():
    """Open an interactive SSH shell on the VPS."""
    if IS_VPS:
        print("[\033[91mERROR\033[0m] Already on the VPS.")
        return
    print(f"[\033[95mBRIDGE\033[0m] Connecting to {VPS_USER}@{VPS_IP}:{VPS_PORT} (venv active)...\n")
    init = f"source {REMOTE_DIR.rstrip('/')}/venv/bin/activate && cd {REMOTE_DIR.rstrip('/')} && exec bash"
    os.execvp("ssh", ["ssh", "-t", "-p", VPS_PORT, f"{VPS_USER}@{VPS_IP}", init])


def _install_status():
    """Show installed units and their live systemctl state."""
    if not MANIFEST_FILE.exists():
        print("[\033[93mINFO\033[0m] No manifest found — nothing installed yet.")
        return

    with open(MANIFEST_FILE) as f:
        manifest = json.load(f)

    print(f"[\033[96mINSTALL STATUS\033[0m] Installed on: {manifest.get('installed_at', 'unknown')}\n")
    for path in manifest.get("files", []):
        unit = Path(path).name
        result = subprocess.run(
            ["systemctl", "is-active", unit],
            capture_output=True, text=True
        )
        active = result.stdout.strip()
        color = "\033[92m" if active == "active" else "\033[91m"
        print(f"  {color}{active:<12}\033[0m {unit}")


def install(show_status: bool = False):
    """Copy infra/ units to systemd, enable timers, write manifest."""
    if show_status:
        _install_status()
        return

    units = sorted(INFRA_DIR.glob("*.service")) + sorted(INFRA_DIR.glob("*.timer"))
    if not units:
        print(f"[\033[91mERROR\033[0m] No .service or .timer files found in {INFRA_DIR}")
        sys.exit(1)

    print("[\033[96mINSTALL\033[0m] Copying systemd units to /etc/systemd/system/...\n")
    installed = []
    for unit in units:
        dest = SYSTEMD_DIR / unit.name
        result = subprocess.run(["sudo", "cp", str(unit), str(dest)])
        if result.returncode == 0:
            print(f"  [\033[92mOK\033[0m]    {unit.name} → {dest}")
            installed.append(str(dest))
        else:
            print(f"  [\033[91mFAIL\033[0m]  {unit.name}")

    print("\n[\033[96mINSTALL\033[0m] Running daemon-reload...")
    subprocess.run(["sudo", "systemctl", "daemon-reload"])

    timers = [u.name for u in units if u.suffix == ".timer"]
    for timer in timers:
        print(f"[\033[96mINSTALL\033[0m] Enabling and starting {timer}...")
        subprocess.run(["sudo", "systemctl", "enable", "--now", timer])

    MANIFEST_DIR.mkdir(parents=True, exist_ok=True)
    manifest = {
        "installed_at": datetime.now(timezone.utc).isoformat(),
        "files": installed,
    }
    with open(MANIFEST_FILE, "w") as f:
        json.dump(manifest, f, indent=2)

    print(f"\n[\033[92mSUCCESS\033[0m] {len(installed)} unit(s) installed.")
    print(f"[\033[96mMANIFEST\033[0m] Written to {MANIFEST_FILE}")


def uninstall():
    """Stop, disable, and remove all units listed in the manifest."""
    if not MANIFEST_FILE.exists():
        print("[\033[91mERROR\033[0m] No manifest found at {MANIFEST_FILE}. Nothing to uninstall.")
        return

    with open(MANIFEST_FILE) as f:
        manifest = json.load(f)

    files = manifest.get("files", [])
    if not files:
        print("[\033[93mWARN\033[0m] Manifest is empty. Nothing to remove.")
        MANIFEST_FILE.unlink()
        return

    print("[\033[91mUNINSTALL\033[0m] Stopping and disabling units...\n")
    for path in files:
        unit = Path(path).name
        print(f"  Stopping   {unit}...")
        subprocess.run(["sudo", "systemctl", "stop",    unit])
        subprocess.run(["sudo", "systemctl", "disable", unit])
        print(f"  Removing   {path}...")
        subprocess.run(["sudo", "rm", "-f", path])
        print()

    print("[\033[91mUNINSTALL\033[0m] Running daemon-reload...")
    subprocess.run(["sudo", "systemctl", "daemon-reload"])

    MANIFEST_FILE.unlink()
    print(f"\n[\033[92mDONE\033[0m] All units removed. Manifest cleaned.")


def shill_cmd():
    """Trigger 0xeeTerm shill cycle on the VPS (or locally)."""
    remote_cmd = f"cd {REMOTE_DIR.rstrip('/')} && venv/bin/python3 0xeeTerm shill"
    if IS_VPS:
        print("[\033[93mVPS\033[0m] Running shill cycle locally...\n")
        subprocess.run(remote_cmd, shell=True)
    else:
        print(f"[\033[95mBRIDGE\033[0m] Running shill cycle on {VPS_IP}...\n")
        subprocess.run(["ssh", "-p", VPS_PORT, f"{VPS_USER}@{VPS_IP}", remote_cmd])


def memory_cmd():
    """Trigger 0xeeTerm memory metrics refresh on the VPS (or locally)."""
    remote_cmd = f"cd {REMOTE_DIR.rstrip('/')} && venv/bin/python3 0xeeTerm memory"
    if IS_VPS:
        print("[\033[93mVPS\033[0m] Running memory metrics refresh locally...\n")
        subprocess.run(remote_cmd, shell=True)
    else:
        print(f"[\033[95mBRIDGE\033[0m] Running memory metrics refresh on {VPS_IP}...\n")
        subprocess.run(["ssh", "-p", VPS_PORT, f"{VPS_USER}@{VPS_IP}", remote_cmd])


def treasury_cmd():
    """Run autonomous treasury cycle on the VPS (portfolio snapshot, stake, bills)."""
    remote_cmd = f"cd {REMOTE_DIR.rstrip('/')} && venv/bin/python3 0xeeTerm treasury"
    if IS_VPS:
        print("[\033[93mVPS\033[0m] Running treasury cycle locally...\n")
        subprocess.run(remote_cmd, shell=True)
    else:
        print(f"[\033[95mBRIDGE\033[0m] Running treasury cycle on {VPS_IP}...\n")
        subprocess.run(["ssh", "-p", VPS_PORT, f"{VPS_USER}@{VPS_IP}", remote_cmd])


def swap_cmd(from_token: str, to_token: str, amount: str):
    """Manual swap via Jupiter on the VPS (or locally)."""
    remote_cmd = f"cd {REMOTE_DIR.rstrip('/')} && venv/bin/python3 0xeeTerm swap {from_token} {to_token} {amount}"
    if IS_VPS:
        print(f"[\033[93mVPS\033[0m] Swap {amount} {from_token.upper()} → {to_token.upper()} locally...\n")
        subprocess.run(remote_cmd, shell=True)
    else:
        print(f"[\033[95mBRIDGE\033[0m] Swap {amount} {from_token.upper()} → {to_token.upper()} on {VPS_IP}...\n")
        subprocess.run(["ssh", "-p", VPS_PORT, f"{VPS_USER}@{VPS_IP}", remote_cmd])


def sys_status():
    if IS_VPS:
        print("[\033[93mVPS\033[0m] Lecture directe des senseurs systemd...\n")
        print("\033[96m[--- ÉTAT DU TIMER ---]\033[0m")
        result = subprocess.run(["systemctl", "list-timers"], capture_output=True, text=True)
        lines = [l for l in result.stdout.splitlines() if "0xeeTerm" in l]
        print("\n".join(lines) if lines else "Aucun timer actif.")
        print()
        print("\033[96m[--- ÉTAT DU SERVICE ---]\033[0m")
        subprocess.run(["systemctl", "status", "0xeeTerm.service", "--no-pager"])
    else:
        print(f"[\033[95mBRIDGE\033[0m] Interrogation SSH sur {VPS_IP}...\n")
        remote_cmd = (
            "echo '[--- ÉTAT DU TIMER ---]';"
            "systemctl list-timers | grep 0xeeTerm || echo 'Aucun timer actif.';"
            "echo '';"
            "echo '[--- ÉTAT DU SERVICE ---]';"
            "systemctl status 0xeeTerm.service --no-pager || true"
        )
        subprocess.run(["ssh", "-p", VPS_PORT, f"{VPS_USER}@{VPS_IP}", remote_cmd])

def sys_logs():
    if IS_VPS:
        print("[\033[93mVPS\033[0m] Extraction locale des journaux...\n")
        subprocess.run(["journalctl", "-u", "0xeeTerm.service", "-n", "15", "--no-pager"])
    else:
        print(f"[\033[95mBRIDGE\033[0m] Extraction SSH des journaux depuis {VPS_IP}...\n")
        subprocess.run(["ssh", "-p", VPS_PORT, f"{VPS_USER}@{VPS_IP}",
                        "journalctl -u 0xeeTerm.service -n 15 --no-pager"])

def show_help():
    print_banner()
    print("Usage: nexus [command]\n")

    print("\033[96m[ GLOBAL ]\033[0m")
    print("  check              : Validate all required .env variables")
    print()

    if IS_VPS:
        print("\033[93m[ VPS COMMANDS ]\033[0m")
        print("  status             : Show 0xeeTerm timer and service state")
        print("  logs               : Show last 15 lines of 0xeeTerm activity")
        print("  restart            : Restart the 0xeeTerm.timer systemd unit")
        print("  trigger heartbeat  : Run a heartbeat cycle immediately")
        print("  trigger mentions   : Run a mentions cycle immediately")
        print("  install            : Copy infra/ units to systemd and enable timers")
        print("  install --status   : Show installed units and their live state")
        print("  uninstall          : Stop, disable and remove all installed units")
        print()
    else:
        print("\033[96m[ LOCAL & BRIDGE ]\033[0m")
        print("  serve              : Start local web server on WEB_DIR:8000")
        print("  deploy             : Push code to VPS via rsync (prompts confirmation)")
        print("  backup             : Pull logs/state.json from VPS to local")
        print("  ssh                : Open an interactive shell on the VPS")
        print()
        print("\033[93m[ REMOTE (SSH) ]\033[0m")
        print("  status             : Query timer and service state on VPS")
        print("  logs               : Fetch last 15 lines of systemd logs from VPS")
        print("  restart            : Restart 0xeeTerm.timer on VPS via SSH")
        print("  trigger heartbeat  : Trigger a heartbeat run on VPS via SSH")
        print("  trigger mentions   : Trigger a mentions run on VPS via SSH")
        print("  memory             : Refresh tweet metrics and show top performers")
        print("  shill              : Scan on-chain txs for paid shill requests")
        print("  treasury           : Run autonomous treasury cycle (portfolio, stake, bills)")
        print("  swap <from> <to> <amount> : Manual swap via Jupiter (sol/usdc/jitosol)")
        print()
        print("\033[95m[ SYSTEMD (run on VPS) ]\033[0m")
        print("  install            : Copy infra/ units to systemd and enable timers")
        print("  install --status   : Show installed units and their live state")
        print("  uninstall          : Stop, disable and remove all installed units")
        print()

    mode = "VPS" if IS_VPS else "LOCAL"
    print(f"Current mode: \033[93m{mode}\033[0m")

if __name__ == "__main__":
    # Rendre le script exécutable s'il ne l'est pas
    if not os.access(__file__, os.X_OK):
        os.chmod(__file__, 0o755)

    if len(sys.argv) < 2:
        show_help()
        sys.exit(0)
    
    cmd = sys.argv[1]
    if cmd == "serve":
        serve()
    elif cmd == "deploy":
        deploy()
    elif cmd == "backup":
        backup()
    elif cmd == "status":
        sys_status()
    elif cmd == "logs":
        sys_logs()
    elif cmd == "restart":
        restart()
    elif cmd == "check":
        check()
    elif cmd == "trigger":
        if len(sys.argv) < 3:
            print(f"[\033[91mERROR\033[0m] Usage: nexus trigger [heartbeat|mentions]")
            sys.exit(1)
        trigger(sys.argv[2])
    elif cmd == "ssh":
        ssh()
    elif cmd == "memory":
        memory_cmd()
    elif cmd == "shill":
        shill_cmd()
    elif cmd == "treasury":
        treasury_cmd()
    elif cmd == "swap":
        if len(sys.argv) < 5:
            print(f"[\033[91mERROR\033[0m] Usage: nexus swap <from> <to> <amount>")
            sys.exit(1)
        swap_cmd(sys.argv[2], sys.argv[3], sys.argv[4])
    elif cmd == "install":
        install(show_status="--status" in sys.argv)
    elif cmd == "uninstall":
        uninstall()
    elif cmd in ["help", "-h", "--help"]:
        show_help()
    else:
        print(f"[\033[91mERROR\033[0m] Unknown command '{cmd}'.")
        show_help()
